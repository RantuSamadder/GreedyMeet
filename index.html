<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GreedyMeet</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* CORE STYLES */
body {
  margin: 0;
  font-family: 'Courier New', monospace;
  background: #03040a;
  color: #00ffe0;
  overflow-x: hidden;
}

/* Binary background animation */
@keyframes floatBits {
  from { transform: translateY(0); opacity: .5; }
  to { transform: translateY(-120vh); opacity: .8; }
}
.binary {
  position: fixed;
  bottom: -10vh;
  font-size: 11px;
  color: rgba(0,255,200,.25);
  animation: floatBits linear infinite;
  pointer-events: none;
  z-index: -1;
}

/* MAIN CONTAINER */
.card {
  background: rgba(0,255,200,.07);
  border: 1px solid #00ffc8;
  border-radius: 14px;
  padding: 20px;
  margin: 20px auto;
  max-width: 1200px; /* Wider for the grid */
  width: 95%; 
  box-shadow: 0 0 16px #00ffc825;
}

/* INPUTS & BUTTONS */
input, select, button {
  padding: 12px;
  margin: 6px 0;
  border-radius: 6px;
  border: 1px solid #00ffc8;
  background: #081616;
  color: #00ffe0;
  box-sizing: border-box;
  width: 100%;
  font-family: inherit;
}

button {
  cursor: pointer;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 1px;
  transition: background 0.3s;
}
button:hover { background: #003737; }

/* SPINNER */
.spinner {
  display: none;
  width: 14px;
  height: 14px;
  border: 3px solid #00ffc844;
  border-top: 3px solid #00ffc8;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  vertical-align: middle;
  margin-left: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* --- SCHEDULE GRID STYLES --- */
.grid-container {
  overflow-x: auto;
  margin: 15px 0;
  border: 1px solid #00ffc8;
  border-radius: 8px;
  max-height: 500px;
  overflow-y: auto;
  background: #020a0a;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 800px;
}

th, td {
  padding: 8px 5px;
  text-align: center;
  border-bottom: 1px solid #00ffc833;
  border-right: 1px solid #00ffc833;
  font-size: 13px;
}

/* Sticky Header (Days) */
thead th {
  position: sticky;
  top: 0;
  background: #002828;
  color: #00ffe0;
  z-index: 10;
  border-bottom: 2px solid #00ffc8;
}

/* Sticky First Column (Time Slots) */
tbody td:first-child, thead th:first-child {
  position: sticky;
  left: 0;
  background: #081616;
  font-weight: bold;
  border-right: 2px solid #00ffc8;
  z-index: 11;
  min-width: 110px;
}

/* Checkbox Cell Hover */
tbody td:not(:first-child):hover {
  background: rgba(0, 255, 200, 0.1);
}

/* Custom Checkbox */
input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: #00ffc8;
  cursor: pointer;
  margin: 0;
}

/* --- DAY SELECTION DROPDOWN STYLING (NEW) --- */
.day-dropdown-content {
  display: none;
  background: #081818;
  border: 1px solid #00ffc8;
  padding: 8px;
  max-height: 250px;
  overflow-y: auto;
  margin-top: -5px;
  margin-bottom: 10px;
  border-radius: 0 0 6px 6px;
  text-align: left;
}
.day-dropdown-content label {
  display: flex;
  align-items: center;
  padding: 6px 8px;
  cursor: pointer;
  border-radius: 4px;
  transition: background 0.2s;
}
.day-dropdown-content label:hover {
  background: rgba(0, 255, 200, 0.15);
}
.day-dropdown-content input[type="checkbox"] {
  width: 16px;
  height: 16px;
  margin: 0 12px 0 0;
}


/* --- FLEX LAYOUT --- */
.flex {
  display: flex;
  gap: 24px;
}

@media (min-width: 900px) {
  .left { flex: 1.2; }
  .right { flex: 0.8; display: flex; align-items: center; } 
}

@media (max-width: 899px) {
  .flex { flex-direction: column; }
  .left, .right { width: 100%; }
  .right {
    margin-top: 20px; 
    border-top: 1px solid #00ffc833; 
    padding-top: 20px;
    min-height: 300px;
  }
}

/* HIGHLIGHT BOXES */
.highlight {
  background: #001f1f;
  padding: 10px;
  border-left: 4px solid #00ffc8;
  margin: 8px 0;
  font-size: 0.9em;
}

.toggle-btn {
  background: #002828;
  margin-bottom: 12px;
  border: 1px dashed #00ffc8;
}

footer {
  text-align: center;
  padding: 20px;
  margin-top: 20px;
  font-size: 13px;
  color: #00ffc8;
  opacity: .7;
  border-top: 1px solid #00ffc833;
}
</style>
</head>

<body>

<script>
// Background Animation
for(let i=0;i<80;i++){
  const b=document.createElement("div");
  b.className="binary";
  b.style.left=Math.random()*100+"vw";
  b.style.animationDuration=(6+Math.random()*12)+"s";
  b.textContent=Math.random()>.5?"0":"1";
  document.body.appendChild(b);
}
</script>

<div class="card">
  <h2 style="text-align:center; margin-bottom:20px;">üìä GreedyMeet</h2>

  <div class="flex">

    <div class="left">

      <button class="toggle-btn" onclick="toggleForm()">‚ûï Submit Class Schedule</button>

      <form id="scheduleForm" style="display:none">
        
        <div style="display:flex; gap:10px;">
          <input id="studentID" placeholder="Student ID" required>
          <input id="group" placeholder="Group Name" required>
        </div>
        
        <p style="font-size:12px; opacity:0.8; margin: 10px 0 5px;">üëá Check the boxes for times when you have <b>Class (Busy)</b>:</p>

        <div class="grid-container">
          <table id="scheduleTable">
            <thead>
              <tr>
                <th style="z-index:20">Time / Day</th> <th>Saturday</th>
                <th>Sunday</th>
                <th>Monday</th>
                <th>Tuesday</th>
                <th>Wednesday</th>
                <th>Thursday</th>
                <th>Friday</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              </tbody>
          </table>
        </div>

        <button type="submit" style="background:#005544; border-color:#00ffc8;">Submit Complete Schedule</button>
      </form>

      <hr style="border-color:#00ffc833; margin: 20px 0;">

      <h3 style="margin-top:0">üîç Find Optimal Slot</h3>
      
      <input id="dashboardGroup" placeholder="Enter Group Name to Search">

      <div>
        <button type="button" class="toggle-btn" style="margin-top: 0;" onclick="toggleDayDropdown()">Select Days to Search ‚ñº</button>
        <div class="day-dropdown-content" id="dayDropdown">
          <label><input type="checkbox" name="searchDay" value="All Days" onchange="selectAllDays(this.checked)"> **Select All Days**</label>
          <hr style="border-color:#00ffc833; margin: 5px 0;">
          <label><input type="checkbox" name="searchDay" value="Saturday"> Saturday</label>
          <label><input type="checkbox" name="searchDay" value="Sunday"> Sunday</label>
          <label><input type="checkbox" name="searchDay" value="Monday"> Monday</label>
          <label><input type="checkbox" name="searchDay" value="Tuesday"> Tuesday</label>
          <label><input type="checkbox" name="searchDay" value="Wednesday"> Wednesday</label>
          <label><input type="checkbox" name="searchDay" value="Thursday"> Thursday</label>
          <label><input type="checkbox" name="searchDay" value="Friday"> Friday</label>
        </div>
      </div>
      
      <button onclick="loadChart()">
        üîç Find Availability
        <span class="spinner" id="loader"></span>
      </button>

      <p style="margin-top:15px">Total Students Responded: <b><span id="totalStudents" style="font-size:1.2em">0</span></b></p>

      <div class="highlight" id="bestSlot">Best Slot: ‚Äî</div>
      <div class="highlight" id="bestDay">Best Day: ‚Äî</div>

    </div>

    <div class="right">
      <canvas id="freeTimeChart"></canvas>
    </div>

  </div>
</div>

<footer>
  <span>¬© Fall 25 GreedyMeet | CSE266.9 Group Project | All rights reserved.</span> 
</footer>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbxlG57FNrAulG6SFlYp4m7BUG5BEaqgecY1lQR-0sRf8rfqjvK5L7meeDgiTgXh44duqQ/exec";

// --- CONFIGURATION ---
const timeSlots = [
  "08:00‚Äì10:00", "08:30‚Äì09:50", "08:30‚Äì10:00", "09:00‚Äì10:00", 
  "10:00‚Äì11:20", "10:00‚Äì12:00", "11:30‚Äì12:50", "11:30‚Äì13:30", 
  "13:30‚Äì14:50", "13:30‚Äì15:30", "15:00‚Äì16:20", "15:00‚Äì17:00", 
  "16:30‚Äì17:50", "16:30‚Äì18:30", "17:00‚Äì19:00"
];
const days = ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

// --- INITIALIZE GRID ---
function initGrid() {
  const tbody = document.getElementById('tableBody');
  let html = "";
  
  timeSlots.forEach(slot => {
    html += `<tr>`;
    html += `<td>${slot}</td>`; // Sticky column
    days.forEach(day => {
      html += `
        <td>
          <input type="checkbox" data-day="${day}" data-time="${slot}">
        </td>
      `;
    });
    html += `</tr>`;
  });
  tbody.innerHTML = html;
}

// Run init
initGrid();

// Toggle Form Visibility
function toggleForm(){
  const form = document.getElementById('scheduleForm');
  form.style.display = form.style.display === "none" ? "block" : "none";
}

// --- DAY SELECT DROPDOWN LOGIC (NEW) ---
function toggleDayDropdown() {
  const dropdown = document.getElementById('dayDropdown');
  dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
}

function selectAllDays(checked) {
  const checkboxes = document.querySelectorAll('#dayDropdown input[name="searchDay"]');
  checkboxes.forEach(cb => {
    if (cb.value !== "All Days") {
      cb.checked = checked;
    }
  });
}

function getSelectedDays() {
  const selectedCheckboxes = document.querySelectorAll('#dayDropdown input[name="searchDay"]:checked');
  let selectedDays = [...selectedCheckboxes]
    .map(cb => cb.value)
    .filter(val => val !== "All Days");

  // If nothing specific is selected, and 'All Days' wasn't checked, default to all days
  if (selectedDays.length === 0) {
    return days;
  }
  return selectedDays;
}

// --- FORM SUBMISSION (BATCHED) ---
document.getElementById('scheduleForm').onsubmit = async (e) => {
  e.preventDefault();

  const studentID = document.getElementById('studentID').value;
  const group = document.getElementById('group').value;

  if(!studentID || !group) {
    alert("Please fill in Student ID and Group.");
    return;
  }

  const payloadMap = {}; 
  const checkboxes = document.querySelectorAll('#tableBody input[type="checkbox"]:checked');
  
  if(checkboxes.length === 0) {
    // Collect all UNCHECKED slots (Free Time) for all days as "OFF" status
    // For simplicity, we will assume a lack of checkmark means no class (free) 
    // and rely on the backend to handle the submission of *busy* times.
    // **NOTE: The current backend logic expects busy slots. If a user submits nothing, it implies they are free all the time, which may be correct but requires them to acknowledge they are done.**
    
    const confirmation = confirm("You have not checked any class times. This means you are available all the time. Is this correct?");
    if (!confirmation) {
        return; 
    }
  }

  // Group busy slots by day
  checkboxes.forEach(cb => {
    const d = cb.getAttribute('data-day');
    const t = cb.getAttribute('data-time');
    if(!payloadMap[d]) payloadMap[d] = [];
    payloadMap[d].push(t);
  });
  
  // Ensure every day is included in the promise array, even if empty (to "clear" previous data for that day)
  const daysToSubmit = new Set([...days, ...Object.keys(payloadMap)]);

  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  submitBtn.textContent = "Processing...";

  const promises = Array.from(daysToSubmit).map(day => {
    // If no slots were selected for a day, send an empty array [] to indicate "all free"
    const slots = payloadMap[day] || [];
    return fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({
        studentID: studentID,
        group: group,
        day: day,
        timeSlots: slots // [] indicates all free/no classes
      })
    });
  });

  try {
    await Promise.all(promises);
    alert(`Successfully Submitted ‚úÖ`);
    toggleForm();
    document.getElementById('scheduleForm').reset();
    initGrid(); // Re-initialize to clear grid state
  } catch (err) {
    console.error(err);
    alert("Error submitting some data. Please check console.");
  } finally {
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  }
};

// --- CHART LOADING LOGIC (MODIFIED) ---
let chart;
function loadChart(){
  const dashboardGroup = document.getElementById('dashboardGroup');
  const loader = document.getElementById('loader');
  const selectedDays = getSelectedDays();

  if(!dashboardGroup.value) {
    alert("Please enter a group name");
    return;
  }
  if(selectedDays.length === 0) {
    alert("Please select at least one day to search.");
    return;
  }
  
  // Collapse the day dropdown
  document.getElementById('dayDropdown').style.display = 'none';

  loader.style.display = "inline-block";

  // Fetch the data from the server
  fetch(`${SCRIPT_URL}?group=${dashboardGroup.value}`)
  .then(r => r.json())
  .then(data => {
    loader.style.display = "none";
    document.getElementById('totalStudents').textContent = data.totalStudents;

    if(!data.freeTime || data.totalStudents === 0) {
       document.getElementById('bestSlot').textContent = `Best Slot: No data found.`;
       document.getElementById('bestDay').textContent = `Best Day Overall: No data found.`;
       if(chart) chart.destroy();
       return;
    }

    let globalMax = -1;
    let globalBestDay = "";
    let globalBestSlot = "";
    let bestAvg = -1;
    let bestDayByAvg = "";
    let bestDayData = {};

    // 1. Find the Overall Best Day/Slot across ALL selected days
    for(const day of selectedDays){
      const dayData = data.freeTime[day] || {};
      let dayVals = Object.values(dayData);
      
      if(dayVals.length > 0) {
        // Find Best Slot of this day
        let max = Math.max(...dayVals);
        let slot = Object.keys(dayData)[dayVals.indexOf(max)];

        // Update Global Max
        if(max > globalMax) {
          globalMax = max;
          globalBestDay = day;
          globalBestSlot = slot;
        }

        // Calculate average for this day (for Best Day By Average)
        let avg = dayVals.reduce((a,b)=>a+b,0) / dayVals.length;
        if(avg > bestAvg){ 
          bestAvg = avg; 
          bestDayByAvg = day;
          bestDayData = dayData;
        }
      }
    }
    
    // Fallback: If no slots were found in any selected day
    if(globalMax === -1) {
       document.getElementById('bestSlot').textContent = `Best Slot: No availability found on selected days.`;
       document.getElementById('bestDay').textContent = `Best Day Overall: No availability.`;
       if(chart) chart.destroy();
       return;
    }


    // 2. Prepare data for the chart (Use the Day with the Highest Average Availability)
    const displayDay = bestDayByAvg;
    const dayData = bestDayData; // The data for the day with the highest average availability
    const labels = Object.keys(dayData);
    const values = Object.values(dayData);


    // 3. Update Highlights
    document.getElementById('bestSlot').textContent = `Best Slot: ${globalBestSlot} on ${globalBestDay} (${globalMax}% free)`;
    document.getElementById('bestDay').textContent = `Chart for Best Day (${displayDay}): ~${bestAvg.toFixed(1)}% free`;


    // 4. Update Chart
    const ctx = document.getElementById('freeTimeChart').getContext("2d");
    const gradient = ctx.createLinearGradient(0,0,0,400);
    gradient.addColorStop(0, "#00ffe0");
    gradient.addColorStop(1, "#007f73");

    if(chart) chart.destroy();
    
    chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: `% Students Free on ${displayDay}`,
          data: values,
          backgroundColor: gradient,
          borderColor: "#00ffc8",
          borderWidth: 1,
          borderRadius: 4,
          hoverBackgroundColor: "#fff"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            grid: { color: "#00ffc822" },
            ticks: { color: "#00ffc8" }
          },
          x: {
            grid: { display: false },
            ticks: { color: "#00ffc8", autoSkip: false, maxRotation: 90, minRotation: 45 }
          }
        },
        plugins: {
          legend: { labels: { color: "#00ffc8" } }
        }
      }
    });

  })
  .catch(err => {
    loader.style.display = "none";
    console.error(err);
    alert("Failed to fetch data.");
  });
}
</script>

</body>
</html>
