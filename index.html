<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GreedyMeet</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:'Courier New', monospace;
  background:#03040a;
  color:#00ffe0;
}

/* Binary background */
@keyframes floatBits{
  from{transform:translateY(0);opacity:.5}
  to{transform:translateY(-120vh);opacity:.8}
}
.binary{
  position:fixed;
  bottom:-10vh;
  font-size:11px;
  color:rgba(0,255,200,.25);
  animation:floatBits linear infinite;
  pointer-events:none;
  z-index:-1;
}

/* Cards */
.card{
  background:rgba(0,255,200,.07);
  border:1px solid #00ffc8;
  border-radius:14px;
  padding:16px;
  margin:16px auto;
  max-width:1100px;
  box-shadow:0 0 16px #00ffc825;
}

/* Inputs */
input,select,button{
  padding:10px;
  margin:6px 0;
  border-radius:6px;
  border:1px solid #00ffc8;
  background:#081616;
  color:#00ffe0;
  font-family:'Courier New', monospace; /* Ensure font consistency */
}
button{
  cursor:pointer;
  font-weight:bold;
}
button:hover{background:#003737}

/* Spinner */
.spinner{
  display:none;
  width:16px;
  height:16px;
  border:3px solid #00ffc844;
  border-top:3px solid #00ffc8;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin-left:8px;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* Dropdown */
.dropdown-content{
  display:none;
  background:#081818;
  border:1px solid #00ffc8;
  padding:8px;
  max-height:200px;
  overflow:auto;
}

/* FLEX LAYOUT (For desktop/tablet) */
.flex{
  display:flex;
  gap:16px;
}
@media(min-width:768px){
  .left,.right{flex:1}
}
/* Mobile Layout (Stacks content) */
@media(max-width:767px){
  .flex{flex-direction:column} /* Stacks .left and .right vertically */
  button,input,select{width:100%}
  /* Optional: Ensure canvas takes full width on mobile */
  #freeTimeChart{width:100% !important; height:auto !important;}
}

/* OFF DAY INLINE */
.offday-row{
  display:flex;
  align-items:center;
  gap:8px;
  margin:6px 0;
}
.offday-row input{
  width:auto;
  margin:0;
}

/* Highlight */
.highlight{
  background:#001f1f;
  padding:8px;
  border-left:4px solid #00ffc8;
  margin:6px 0;
}

.toggle-btn{
  background:#002828;
  margin-bottom:8px;
  width:100%; /* Make button full width on all screens */
}

/* FOOTER */
footer{
  text-align:center;
  padding:14px;
  margin-top:20px;
  font-size:13px;
  color:#00ffc8;
  opacity:.7;
  border-top:1px solid #00ffc833;
}
footer span{
  opacity:.9;
}
</style>
</head>

<body>

<script>
// --- Binary Background Script ---
for(let i=0;i<120;i++){
  const b=document.createElement("div");
  b.className="binary";
  b.style.left=Math.random()*100+"vw";
  b.style.animationDuration=(6+Math.random()*12)+"s";
  b.textContent=Math.random()>.5?"0":"1";
  document.body.appendChild(b);
}
</script>

<div class="card">
<h2 style="text-align:center">üìä GreedyMeet ‚Äì Meeting Slot Finder for Groups</h2>

<div class="flex">

<div class="left">

<button class="toggle-btn" onclick="toggleForm()">‚ûï Submit Your Class Schedule</button>

<form id="scheduleForm" style="display:none">

<input id="studentID" placeholder="Student ID" required>
<input id="group" placeholder="Group Name" required>

<select id="day">
<option>Saturday</option><option>Sunday</option><option>Monday</option>
<option>Tuesday</option><option>Wednesday</option>
<option>Thursday</option><option>Friday</option>
</select>

<div class="offday-row">
  <input type="checkbox" id="offDay">
  <label for="offDay">OFF day</label>
</div>

<div id="slotBox">
<button type="button" onclick="toggleSlots()">Select Time Slots ‚ñº</button>
<div class="dropdown-content" id="slotDropdown">
<label><input type="checkbox" value="08:30‚Äì09:50"> 08:30‚Äì09:50</label><br>
<label><input type="checkbox" value="10:00‚Äì11:20"> 10:00‚Äì11:20</label><br>
<label><input type="checkbox" value="13:30‚Äì14:50"> 13:30‚Äì14:50</label><br>
<label><input type="checkbox" value="15:00‚Äì16:20"> 15:00‚Äì16:20</label>
</div>
</div>

<button type="submit">Submit Schedule</button>
</form>

<hr style="border-color:#00ffc833">

<h3>Find Group Availability</h3>

<input id="dashboardGroup" placeholder="Group Name" required>

<select id="daySelect">
<option>Saturday</option><option>Sunday</option><option>Monday</option>
<option>Tuesday</option><option>Wednesday</option>
<option>Thursday</option><option>Friday</option>
</select>

<button onclick="loadChart()">
  üîç Find Availability
  <span class="spinner" id="loader"></span>
</button>

<p>Total Students Submitted: <b><span id="totalStudents">0</span></b></p>

<div class="highlight" id="bestSlot">Best Slot: </div>
<div class="highlight" id="bestDay">Best Day: </div>

</div>

<div class="right">
<canvas id="freeTimeChart"></canvas>
</div>

</div>
</div>

<footer>
  <span>¬© Fall 25 GreedyMeet | Algorithm Lab Project | All rights reserved.</span>
</footer>

<script>
// NOTE: Replace this with your actual Google Apps Script URL
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbxlG57FNrAulG6SFlYp4m7BUG5BEaqgecY1lQR-0sRf8rfqjvK5L7meeDgiTgXh44duqQ/exec";

function toggleForm(){
  scheduleForm.style.display =
    scheduleForm.style.display==="none"?"block":"none";
}
function toggleSlots(){
  // Toggle the visibility of the dropdown content
  const currentDisplay = slotDropdown.style.display;
  slotDropdown.style.display = currentDisplay === "block" ? "none" : "block";
}

// Event listener for the 'OFF day' checkbox
document.getElementById('offDay').onchange=function(){
  document.getElementById('slotBox').style.display = this.checked ? "none" : "block";
};

// Form Submission Handler
document.getElementById('scheduleForm').onsubmit=e=>{
  e.preventDefault();
  
  const studentID = document.getElementById('studentID').value;
  const group = document.getElementById('group').value;
  const day = document.getElementById('day').value;
  const offDayChecked = document.getElementById('offDay').checked;
  
  let slots;
  if (offDayChecked) {
    slots = ["OFF"];
  } else {
    // Get all checked checkboxes in the slotDropdown and map their values
    slots = [...document.querySelectorAll("#slotDropdown input:checked")].map(x=>x.value);
    
    // Basic validation check if no slots are selected and it's not an OFF day
    if (slots.length === 0) {
      alert("Please select at least one time slot or check 'OFF day'.");
      return; 
    }
  }

  fetch(SCRIPT_URL,{
    method:"POST",
    headers: {
        'Content-Type': 'application/json',
    },
    body:JSON.stringify({
      studentID:studentID,
      group:group,
      day:day,
      timeSlots:slots
    })
  })
  .then(response => response.ok ? response.text() : Promise.reject('Submission failed'))
  .then(()=>alert("Schedule Submitted Successfully! ‚úÖ"))
  .catch(error => {
    console.error('Error:', error);
    alert("Submission Failed. Check console for details.");
  });
};

let chart;

// Function to fetch data and draw the chart
function loadChart(){
  const groupName = document.getElementById('dashboardGroup').value;
  if (!groupName) {
      alert("Please enter a Group Name to find availability.");
      return;
  }
  
  const selectedDay = document.getElementById('daySelect').value;
  loader.style.display="inline-block";

  fetch(`${SCRIPT_URL}?group=${encodeURIComponent(groupName)}`)
  .then(r => {
    if (!r.ok) {
        throw new Error(`HTTP error! status: ${r.status}`);
    }
    return r.json();
  })
  .then(data=>{
    loader.style.display="none";
    
    // Check if data structure is valid
    if (!data || !data.freeTime) {
        totalStudents.textContent = 0;
        bestSlot.textContent = "Best Slot: No data received.";
        bestDay.textContent = "Best Day: No data received.";
        if (chart) chart.destroy();
        alert("No data found for this group, or API structure is incorrect.");
        return;
    }

    totalStudents.textContent=data.totalStudents || 0;

    const dayData=data.freeTime[selectedDay] || {};
    const labels=Object.keys(dayData).filter(key => key !== 'OFF'); // Exclude 'OFF' from chart
    const values=labels.map(label => dayData[label]); // Get corresponding values

    // Check if there are any slots for the selected day (excluding OFF)
    if (labels.length === 0) {
        if (chart) chart.destroy();
        const offCount = dayData['OFF'] || 0;
        alert(`No class slots found for ${selectedDay}. ${offCount} students marked it as an OFF day.`);
        bestSlot.textContent = `Best Slot: N/A for ${selectedDay}.`;
        bestDay.textContent = `Best Day: Recalculating...`;
    }

    const ctx = document.getElementById("freeTimeChart").getContext("2d");
    const gradient = ctx.createLinearGradient(0,0,0,300);
    gradient.addColorStop(0,"#00ffe0");
    gradient.addColorStop(1,"#007f73");

    if(chart) chart.destroy();
    
    chart=new Chart(ctx,{
      type:"bar",
      data:{
        labels:labels,
        datasets:[{
          data:values,
          label:"Free Students %",
          backgroundColor:gradient,
          borderColor:"#00ffc8",
          borderWidth:1,
          borderRadius:6
        }]
      },
      options:{
        responsive: true,
        maintainAspectRatio: false, // Allows chart to resize on mobile
        plugins: {
            legend: {
                display: false
            }
        },
        scales:{
          y:{
            beginAtZero:true,
            max:100,
            title: {
                display: true,
                text: 'Percentage of Free Students',
                color: '#00ffc8'
            },
            ticks: {
                color: '#00ffe0'
            },
            grid:{color:"#00ffc822"}
          },
          x:{
            ticks: {
                color: '#00ffe0'
            },
            grid:{color:"#00ffc811"}
          }
        }
      }
    });
    
    // --- Best Slot Calculation for the selected day ---
    let max = -1;
    let slot = "N/A";
    if (values.length > 0) {
        max = Math.max(...values);
        slot = labels[values.indexOf(max)];
    }
    
    bestSlot.innerHTML=`Best Slot on <b>${selectedDay}</b>: ${slot} (${max.toFixed(1)}% free)`;

    // --- Best Day Calculation (Averaging all days) ---
    let bestD="",bestAvg=-1;
    let totalSlots = 0; // Number of slots (excluding 'OFF')
    if (labels.length > 0) {
        totalSlots = labels.length;
    }

    for(const d in data.freeTime){
        const daySlots = data.freeTime[d];
        const dayValues = Object.keys(daySlots).filter(key => key !== 'OFF').map(key => daySlots[key]);
        
        if (dayValues.length > 0) {
            let sum = dayValues.reduce((a,b)=>a+b,0);
            let avg = sum / dayValues.length;
            
            if(avg>bestAvg){
                bestAvg=avg;
                bestD=d;
            }
        }
    }
    
    if (bestD) {
        bestDay.innerHTML=`Best Day overall: <b>${bestD}</b> (Avg ${bestAvg.toFixed(1)}% free)`;
    } else {
        bestDay.innerHTML=`Best Day overall: Not enough class data to calculate.`;
    }

  })
  .catch(error => {
    loader.style.display="none";
    console.error('Fetch Error:', error);
    alert(`Failed to load data. Please check the Group Name and API URL. Error: ${error.message}`);
  });
}
</script>

</body>
</html>
