<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GreedyMeet</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* CORE STYLES */
body {
  margin: 0;
  font-family: 'Courier New', monospace;
  background: #03040a;
  color: #00ffe0;
  overflow-x: hidden;
}

/* Binary background animation */
@keyframes floatBits {
  from { transform: translateY(0); opacity: .5; }
  to { transform: translateY(-120vh); opacity: .8; }
}
.binary {
  position: fixed;
  bottom: -10vh;
  font-size: 11px;
  color: rgba(0,255,200,.25);
  animation: floatBits linear infinite;
  pointer-events: none;
  z-index: -1;
}

/* MAIN CONTAINER */
.card {
  background: rgba(0,255,200,.07);
  border: 1px solid #00ffc8;
  border-radius: 14px;
  padding: 20px;
  margin: 20px auto;
  max-width: 1200px; /* Wider for the grid */
  width: 95%; 
  box-shadow: 0 0 16px #00ffc825;
}

/* INPUTS & BUTTONS */
input, select, button {
  padding: 12px;
  margin: 6px 0;
  border-radius: 6px;
  border: 1px solid #00ffc8;
  background: #081616;
  color: #00ffe0;
  box-sizing: border-box;
  width: 100%;
  font-family: inherit;
}

button {
  cursor: pointer;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 1px;
  transition: background 0.3s;
}
button:hover { background: #003737; }

/* SPINNER */
.spinner {
  display: none;
  width: 14px;
  height: 14px;
  border: 3px solid #00ffc844;
  border-top: 3px solid #00ffc8;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  vertical-align: middle;
  margin-left: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* --- SCHEDULE GRID STYLES (NEW) --- */
.grid-container {
  overflow-x: auto; /* Scroll horizontally on mobile */
  margin: 15px 0;
  border: 1px solid #00ffc8;
  border-radius: 8px;
  max-height: 500px; /* Vertical scroll if too tall */
  overflow-y: auto;
  background: #020a0a;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 800px; /* Forces scroll on small screens */
}

th, td {
  padding: 8px 5px;
  text-align: center;
  border-bottom: 1px solid #00ffc833;
  border-right: 1px solid #00ffc833;
  font-size: 13px;
}

/* Sticky Header (Days) */
thead th {
  position: sticky;
  top: 0;
  background: #002828;
  color: #00ffe0;
  z-index: 10;
  border-bottom: 2px solid #00ffc8;
}

/* Sticky First Column (Time Slots) */
tbody td:first-child, thead th:first-child {
  position: sticky;
  left: 0;
  background: #081616;
  font-weight: bold;
  border-right: 2px solid #00ffc8;
  z-index: 11; /* Higher than normal headers */
  min-width: 110px;
}

/* Checkbox Cell Hover */
tbody td:not(:first-child):hover {
  background: rgba(0, 255, 200, 0.1);
}

/* Custom Checkbox */
input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: #00ffc8;
  cursor: pointer;
  margin: 0;
}

/* --- FLEX LAYOUT --- */
.flex {
  display: flex;
  gap: 24px;
}

@media (min-width: 900px) {
  .left { flex: 1.2; } /* Give more space to grid */
  .right { flex: 0.8; display: flex; align-items: center; } 
}

@media (max-width: 899px) {
  .flex { flex-direction: column; }
  .left, .right { width: 100%; }
  .right {
    margin-top: 20px; 
    border-top: 1px solid #00ffc833; 
    padding-top: 20px;
    min-height: 300px;
  }
}

/* HIGHLIGHT BOXES */
.highlight {
  background: #001f1f;
  padding: 10px;
  border-left: 4px solid #00ffc8;
  margin: 8px 0;
  font-size: 0.9em;
}

.toggle-btn {
  background: #002828;
  margin-bottom: 12px;
  border: 1px dashed #00ffc8;
}

footer {
  text-align: center;
  padding: 20px;
  margin-top: 20px;
  font-size: 13px;
  color: #00ffc8;
  opacity: .7;
  border-top: 1px solid #00ffc833;
}
</style>
</head>

<body>

<script>
// Background Animation
for(let i=0;i<80;i++){
  const b=document.createElement("div");
  b.className="binary";
  b.style.left=Math.random()*100+"vw";
  b.style.animationDuration=(6+Math.random()*12)+"s";
  b.textContent=Math.random()>.5?"0":"1";
  document.body.appendChild(b);
}
</script>

<div class="card">
  <h2 style="text-align:center; margin-bottom:20px;">üìä GreedyMeet</h2>

  <div class="flex">

    <div class="left">

      <button class="toggle-btn" onclick="toggleForm()">‚ûï Submit Class Schedule</button>

      <form id="scheduleForm" style="display:none">
        
        <div style="display:flex; gap:10px;">
          <input id="studentID" placeholder="Student ID" required>
          <input id="group" placeholder="Group Name" required>
        </div>
        
        <p style="font-size:12px; opacity:0.8; margin: 10px 0 5px;">üëá Check the boxes for times when you have <b>Class (Busy)</b>:</p>

        <div class="grid-container">
          <table id="scheduleTable">
            <thead>
              <tr>
                <th style="z-index:20">Time / Day</th> <th>Saturday</th>
                <th>Sunday</th>
                <th>Monday</th>
                <th>Tuesday</th>
                <th>Wednesday</th>
                <th>Thursday</th>
                <th>Friday</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              </tbody>
          </table>
        </div>

        <button type="submit" style="background:#005544; border-color:#00ffc8;">Submit Complete Schedule</button>
      </form>

      <hr style="border-color:#00ffc833; margin: 20px 0;">

      <h3 style="margin-top:0">üîç Find Optimal Slot</h3>
      
      <input id="dashboardGroup" placeholder="Enter Group Name to Search">

      <select id="daySelect">
        <option>Saturday</option><option>Sunday</option><option>Monday</option>
        <option>Tuesday</option><option>Wednesday</option>
        <option>Thursday</option><option>Friday</option>
      </select>

      <button onclick="loadChart()">
        üîç Find Availability
        <span class="spinner" id="loader"></span>
      </button>

      <p style="margin-top:15px">Total Students Responded: <b><span id="totalStudents" style="font-size:1.2em">0</span></b></p>

      <div class="highlight" id="bestSlot">Best Slot: ‚Äî</div>
      <div class="highlight" id="bestDay">Best Day: ‚Äî</div>

    </div>

    <div class="right">
      <canvas id="freeTimeChart"></canvas>
    </div>

  </div>
</div>

<footer>
  <span>¬© Fall 25 GreedyMeet | Algorithm Lab Project | All rights reserved.</span> 
</footer>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbxlG57FNrAulG6SFlYp4m7BUG5BEaqgecY1lQR-0sRf8rfqjvK5L7meeDgiTgXh44duqQ/exec";

// --- CONFIGURATION ---
const timeSlots = [
  "08:00‚Äì10:00", "08:30‚Äì09:50", "08:30‚Äì10:00", "09:00‚Äì10:00", 
  "10:00‚Äì11:20", "10:00‚Äì12:00", "11:30‚Äì12:50", "11:30‚Äì13:30", 
  "13:30‚Äì14:50", "13:30‚Äì15:30", "15:00‚Äì16:20", "15:00‚Äì17:00", 
  "16:30‚Äì17:50", "16:30‚Äì18:30", "17:00‚Äì19:00"
];
const days = ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

// --- INITIALIZE GRID ---
function initGrid() {
  const tbody = document.getElementById('tableBody');
  let html = "";
  
  timeSlots.forEach(slot => {
    html += `<tr>`;
    html += `<td>${slot}</td>`; // Sticky column
    days.forEach(day => {
      // Create checkbox with data attributes for easy retrieval
      html += `
        <td>
          <input type="checkbox" data-day="${day}" data-time="${slot}">
        </td>
      `;
    });
    html += `</tr>`;
  });
  tbody.innerHTML = html;
}

// Run init
initGrid();

// Toggle Form Visibility
function toggleForm(){
  const form = document.getElementById('scheduleForm');
  form.style.display = form.style.display === "none" ? "block" : "none";
}

// --- FORM SUBMISSION (BATCHED) ---
document.getElementById('scheduleForm').onsubmit = async (e) => {
  e.preventDefault();

  const studentID = document.getElementById('studentID').value;
  const group = document.getElementById('group').value;

  if(!studentID || !group) {
    alert("Please fill in Student ID and Group.");
    return;
  }

  // Collect data per day
  const payloadMap = {}; // Key: Day, Value: Array of slots
  let hasSelection = false;

  const checkboxes = document.querySelectorAll('#tableBody input[type="checkbox"]:checked');
  
  if(checkboxes.length === 0) {
    alert("Please select at least one class time.");
    return;
  }

  checkboxes.forEach(cb => {
    const d = cb.getAttribute('data-day');
    const t = cb.getAttribute('data-time');
    if(!payloadMap[d]) payloadMap[d] = [];
    payloadMap[d].push(t);
  });

  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  submitBtn.textContent = "Processing...";

  // Create an array of Fetch Promises (one per active day)
  const promises = Object.keys(payloadMap).map(day => {
    return fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({
        studentID: studentID,
        group: group,
        day: day,
        timeSlots: payloadMap[day]
      })
    });
  });

  try {
    await Promise.all(promises);
    alert(`Successfully Submitted Schedule for ${Object.keys(payloadMap).length} days! ‚úÖ`);
    toggleForm();
    // Optional: Reset form
    document.getElementById('scheduleForm').reset();
  } catch (err) {
    console.error(err);
    alert("Error submitting some data. Please try again.");
  } finally {
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  }
};

// --- CHART LOADING LOGIC (UNCHANGED) ---
let chart;
function loadChart(){
  const dashboardGroup = document.getElementById('dashboardGroup');
  const daySelect = document.getElementById('daySelect');
  const loader = document.getElementById('loader');

  if(!dashboardGroup.value) {
    alert("Please enter a group name");
    return;
  }

  loader.style.display = "inline-block";

  fetch(`${SCRIPT_URL}?group=${dashboardGroup.value}`)
  .then(r => r.json())
  .then(data => {
    loader.style.display = "none";
    document.getElementById('totalStudents').textContent = data.totalStudents;

    if(!data.freeTime || !data.freeTime[daySelect.value]) {
       alert("No data found for this group/day.");
       return;
    }

    const dayData = data.freeTime[daySelect.value];
    const labels = Object.keys(dayData);
    const values = Object.values(dayData);

    const ctx = document.getElementById('freeTimeChart').getContext("2d");
    const gradient = ctx.createLinearGradient(0,0,0,400);
    gradient.addColorStop(0, "#00ffe0");
    gradient.addColorStop(1, "#007f73");

    if(chart) chart.destroy();
    
    chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "% Students Free",
          data: values,
          backgroundColor: gradient,
          borderColor: "#00ffc8",
          borderWidth: 1,
          borderRadius: 4,
          hoverBackgroundColor: "#fff"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            grid: { color: "#00ffc822" },
            ticks: { color: "#00ffc8" }
          },
          x: {
            grid: { display: false },
            ticks: { color: "#00ffc8", autoSkip: false, maxRotation: 90, minRotation: 45 }
          }
        },
        plugins: {
          legend: { labels: { color: "#00ffc8" } }
        }
      }
    });

    // Insights
    let max = Math.max(...values);
    let slot = labels[values.indexOf(max)];
    document.getElementById('bestSlot').textContent = `Best Slot: ${slot} (${max}% free)`;

    let bestD = "", bestAvg = 0;
    for(const d in data.freeTime){
      let dayVals = Object.values(data.freeTime[d]);
      if(dayVals.length > 0) {
        let avg = dayVals.reduce((a,b)=>a+b,0) / dayVals.length;
        if(avg > bestAvg){ bestAvg = avg; bestD = d; }
      }
    }
    document.getElementById('bestDay').textContent = `Best Day Overall: ${bestD} (~${bestAvg.toFixed(1)}% free)`;
  })
  .catch(err => {
    loader.style.display = "none";
    console.error(err);
    alert("Failed to fetch data.");
  });
}
</script>

</body>
</html>
